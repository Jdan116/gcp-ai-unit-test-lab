name: Java CI + JaCoCo + Clickable Uncovered Methods

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-test-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: ⚙️ Set up Gradle (cache)
        uses: gradle/gradle-build-action@v2

      - name: ✅ Build, test, and generate JaCoCo (XML/HTML/CSV)
        run: ./gradlew clean test jacocoTestReport

      - name: 🔎 Verify JaCoCo outputs
        run: |
          ls -la build/reports/jacoco/test || true
          test -f build/reports/jacoco/test/jacocoTestReport.xml
          test -f build/reports/jacoco/test/jacocoTestReport.csv

      # Optional: badges + summary table (uses CSV)
      - name: 📊 Generate coverage badges & summary
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: build/reports/jacoco/test/jacocoTestReport.csv
          badges-directory: .github/badges
          coverage-badge-filename: coverage.svg
          branches-badge-filename: branches.svg
          generate-coverage-badge: true
          generate-branches-badge: true
          on-missing-report: fail
          fail-if-coverage-less-than: 70
          fail-if-branches-less-than: 50
          generate-summary: true
          summary-filename: coverage-summary.md
          generate-workflow-summary: true
          workflow-summary-heading: "JaCoCo Coverage Summary"

      - name: 📦 Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            build/reports/jacoco/test/html
            build/reports/jacoco/test/jacocoTestReport.xml
            build/reports/jacoco/test/jacocoTestReport.csv

      # ---- Clickable uncovered methods PR comment ----
      - name: 🧰 Ensure script is executable
        run: chmod +x .github/scripts/list_uncovered_methods.py

      - name: 🧮 Generate uncovered methods markdown
        id: uncovered
        env:
          # Prefer PR head sha for links; fallback to the current sha
          LINK_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          python3 .github/scripts/list_uncovered_methods.py build/reports/jacoco/test/jacocoTestReport.xml > uncovered.md
          echo "Generated uncovered.md:"
          head -n 50 uncovered.md || true

      - name: 💬 Post sticky PR comment with uncovered methods
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: uncovered.md
