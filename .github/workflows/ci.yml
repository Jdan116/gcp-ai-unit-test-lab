name: Java CI with Gradle + JaCoCo + PR Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: ⚙️ Set up Gradle (cache)
        uses: gradle/gradle-build-action@v2

      - name: ✅ Test + JaCoCo
        run: gradle clean test jacocoTestReport

      - name: 🔎 Verify JaCoCo XML exists
        run: |
          ls -la build/reports/jacoco/test || true
          test -f build/reports/jacoco/test/jacocoTestReport.xml || (echo "❌ XML not found"; exit 1)

      # --- Parse JaCoCo and generate Markdown + badges ---
      - name: 📊 Generate coverage summary + badges
        id: jacoco
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-report-path: ""               # leave blank (we use XML)
          jacoco-report-path: build/reports/jacoco/test/jacocoTestReport.xml
          generate-branches-badge: true
          generate-summary: true
          summary-filename: coverage-summary.md
          fail-on-coverage-decrease: false         # set true if you keep history
          minimum-coverage: 0                       # set e.g. 80 to gate merges

      - name: 📋 Add coverage to job summary
        run: cat coverage-summary.md >> $GITHUB_STEP_SUMMARY

      - name: 💬 Sticky PR comment with coverage
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: coverage-summary.md

      # --- Artifacts for drill-down in browser ---
      - name: 📦 Upload JaCoCo HTML
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-html-report
          path: build/reports/jacoco/test/html
          if-no-files-found: warn

      - name: 📦 Upload JaCoCo XML
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml-report
          path: build/reports/jacoco/test/jacocoTestReport.xml
          if-no-files-found: warn
